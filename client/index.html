<!DOCTYPE html>
<!--

Have fun!

Message kqwq#2348 on Discord or @squishypill on Twitter if you have any questions/concerns.

-->
<html>

<head>
  <meta charset="utf-8">
  <title>KA Metaverse</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.0/simplepeer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/globe.gl@2.22.8/dist/globe.gl.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
      border-radius: 10px;
    }

    /* STYLE.HOME */
    #home-instructions-container {
      background-color: rgba(0, 0, 0, 0.65);
      z-index: 2;
      position: absolute;
      left: 10px;
      bottom: 10px;
      padding: 2px;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      color: white;
      font-family: monospace;
    }

    #logged-in-as {
      color: gray;
    }

    .btn-glass {
      /* Translucent background, white text, set border, rounded corners */
      pointer-events: auto;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 16px;
      font-weight: bold;
      padding: 10px;
      margin: 24px;
      cursor: pointer;
      z-index: 2;
      /* Make text non-selectable */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    button:hover {
      background-color: rgba(255, 255, 255, 0.4);
    }

    #btn-container {
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      /* Align buttons to center */
      text-align: center;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    /* STYLE.LOGIN */
    #home-login {
      background-color: rgb(253, 253, 253);
      position: absolute;
      top: 0;
      left: 0;
      width: 95%;
      height: 95%;
      margin: 20px;
    }

    #home-login b {
      color: blue;
    }

    #home-login button {
      margin: 10px;
    }

    #pp {
      font-family: Arial;
      margin-top: 30px;
      width: 380px;
      border: 1px solid rgb(204, 204, 204);
      border-radius: 7px;
      padding-left: 10px;
      box-shadow: 0px 0px 5px rgb(204, 204, 204);
      padding: 15px 21px;

      /* Align items left to right, pinned to top (Thanks GitHub Copilot) */
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    #pp img {
      width: 64px;
    }

    #pp>div {
      margin-left: 15px;
      min-width: 0;
    }

    #pp-names {
      display: flex;
      align-items: center;
    }

    #pp-names * {
      margin: 0;
      padding: 0;
    }

    #pp-real-name {
      font-size: 20px;
      font-weight: bold;
      white-space: nowrap;
    }

    #pp-username-container {
      display: inline-flex;
      margin-left: 3px;
      color: #9E9FA2;
      font-size: 16px;
      font-weight: normal;
      min-width: 0;
    }

    #pp-username {
      color: #9E9FA2;
      font-size: 16px;
      font-weight: normal;
      /* Strip styling from input */
      border: none;
      background: none;
      outline: none;
    }

    #pp-bio {
      font-size: 16px;
    }

    #pp-ep {
      color: #0A2A66;
      font-weight: bold;
      font-size: 16px;
      float: right;
    }

    /* STYLE.REST */
    .toolbar {
      background-color: rgba(252, 252, 252, 0.9);
      position: absolute;
      top: 0px;
      left: 0px;
      padding: 1px;
      width: 100%;
      font-size: 15px;
      z-index: 999;
      height: 20px;
      line-height: 18px;
    }

    #kam-views a {
      color: navy;
    }

    #kam-views a.active {
      font-weight: bold;
      pointer-events: none;
    }

    #kam-views a:hover {
      color: orangered;
    }

    #kam-username {
      color: gray;
    }

    #game-list {
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
    }

    .game-item {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 200px;
      height: 200px;
      display: flex;
      flex-direction: column;
    }

    .game-item-title {
      font-size: 20px;
      font-weight: bold;
      color: gray;
      font-family: monospace;
      text-align: left;
    }

    .game-item-title:hover {
      color: #555;
    }

    .game-item-actions {
      /* Pin items to the bottom of div */
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    #editor-options {
      position: absolute;
      top: 40px;
      right: 30px;
      width: 123px;
      height: 50px;
      padding: 3px;
      border-radius: 2px;
      background-color: rgba(11, 0, 24, 0.6);

      /* Draggable */
      cursor: move;
      z-index: 5;
    }

    #editor-options:hover {
      background-color: rgba(11, 0, 24, 0.8);
    }


    #editor-options button {
      padding: 3px;
    }

    #editor-options span {
      color: white;
      float: right;
      font-size: 12px;
      font-family: monospace;
    }


    #view-html,
    #view-server,
    #view-stdout,
    #view-view,
    #home-games-project-join {
      position: absolute;
      top: 21px;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #view-iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    /* STYLE.BUILD */
    #home-build label {
      font-size: 16px;
      font-weight: bold;
      color: #0A2A66;
      margin-bottom: 0;
    }

    #share-popup {
      /* Center popup */
      z-index: 999;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 550px;
      padding: 10px;
    }
    .modal-content {
      max-height: 95vh;
      overflow: auto;
    }

    #ka-source-code {
      width: 100%;
      height: 200px;
    }
  </style>
</head>

<body>
  <!-- Toolbar pinned to the top that contains the current directory (page) and view optioons when page is "home-game-project-edit" -->
  <div class="toolbar">
    <div class="col md-12">
      <div class="float-left">
        <span id="kam-status">Connecting<span class="loading"></span></span>
        <span id="kam-breadcrumbs">-</span>
      </div>
      <div class="float-right">
        <span id="kam-views">
          <a href="javascript:void(0)" id='html' onclick="chView('html')">html</a> |
          <a href="javascript:void(0)" id='view' onclick="chView('view')">view</a>&nbsp;
          <a href="javascript:void(0)" id='server' onclick="chView('server')">server</a> |
          <a href="javascript:void(0)" id='stdout' onclick="chView('stdout')">stdout</a>
        </span>
      </div>
    </div>
  </div>

  <!-- Home page with cool spinning globe in background -->
  <div class="page" id="home">
    <div id="globeViz"></div>

    <div id="btn-container">
      <button class="btn-glass" onclick="chPage('home-login')" onmouseenter="putInstructions('login')"
        onmouseleave="putInstructions()" id="btn-login">Login</button>
      <button class="btn-glass" onclick="chPage('home-games')" onmouseenter="putInstructions('enter')"
        onmouseleave="putInstructions()">Enter</button>
      <button class="btn-glass" onclick="chPage('home-build')" onmouseenter="putInstructions('build')"
        onmouseleave="putInstructions()">Build</button>
    </div>

    <div id="home-instructions-container">
      <span id="home-instructions"></span>
      <span>Share - <a onclick="openSharePopup()" href="javascript:void(0)">options</a></span>
      <span id="logged-in-as-container" style="display:none">Logged in as <span id="logged-in-as"></span> <a
          href="javascript:void(0)" onclick="chName()" id="edit-name">edit name</a></span>
      <span id="white-screen">White screen? <a href="javascript:void(0)" onclick="hideGraphics(true)">hide graphics</a>
        - <a href="javascript:void(0)" onclick="hideGraphics(false)">dismiss</a></span>
      <span id="not-connected" style="display:none">You are disconnected <a href="javascript:void(0)"
          onclick="connectToServer()">reconnect</a></span>
    </div>
  </div>

  <!-- Dynamic login page -->
  <div class="page mt-3" id="home-login">
    <!-- Khan Academy profile preview (pp) card -->
    <div id="pp">
      <img id="pp-avatar">
      <div>
        <div id="pp-names">
          <span id="pp-real-name"></span>
          <span id="pp-username-container">@<input autocomplete="off" id="pp-username"
              placeholder="Enter your username or KAID" onkeyup="fetchUsername()"></span>
        </div>
        <p id="pp-bio"></p>
        <span id="pp-ep"></span>
      </div>
    </div>
    <div class="input-group">
      <button class="btn btn-primary" id="btn-login-as" onclick="logInAs()">Log in as <span
          id="login-as-username">[Unknown]</span></button>
      <button class="btn btn-secondary" id="btn-continue-as-guest" onclick="chPage('home')">Continue as guest</button>
    </div>
    <div id="bio-change-container" class="mt-3">
      <h3>Step 2 - Verify your account</h3>
      <p id="bio-change-instructions">To ensure this account belongs to you, add the <b id="bio-add-pin">[error, do not
          add this]</b> PIN to your Khan
        Academy bio. You can edit your bio
        with <a href="https://www.khanacademy.org/profile/me" target="_blank">this link</a>.</p>
      <button class="btn btn-primary" id="btn-verify" onclick="verifyBioChange()">Verify</button>
    </div>
  </div>

  <div class="container page mt-5" id="home-games">
    <div class="d-flex justify-content-center">
      <input autocomplete="off" id="games-search" placeholder="Search games" onkeyup="searchGames()" class="form-control col-4">
      <button onclick="getProjects()" class="btn btn-light btn-sm">Refresh</button>
    </div>
    <hr/>
    <div id="game-list"> </div>
  </div>

  <div class="container page mt-5" id="home-games-project">
    <h4 id="kam-proj-title">Project</h4>
    <p id="kam-proj-desc" contenteditable="true">-</p>
    Version: <p id="kam-proj-version" contenteditable="true">-</p>
    <form>
      <div class="form-group form-check">
        <input class="form-check-input" type="checkbox" value="" id="kam-proj-is-template">
        <label class="form-check-label" for="kam-proj-is-template">List as Template</label>
      </div>
    </form>
    Max players (2-100): <p id="kam-proj-max-players" contenteditable="true">-</p>
    Views: <span id="kam-proj-views">-</span><br>
    Author: <b id="kam-proj-author">-</b>
    <br><br>
    <button class="btn btn-primary" onclick="joinProject()" id="kam-proj-join">Join</button>
    <button class="btn btn-dark" onclick="editProjectButton()" id="kam-proj-edit">Edit</button>
    <button class="btn btn-warning" onclick="updateProjectInfo()" id="kam-proj-save">Update info</button>
    <button class="btn btn-danger" onclick="deleteProject()" id="kam-proj-delete">Delete</button>
    <hr/>
  </div>

  <div class="page mt-5" id="home-games-project-edit">
    <div id="view-server">function foo(items) {
      var x = "All this is syntax highlighted";
      return x;
    </div>
    <div id="view-html">
      <div id="editor-html">Loading HTML...</div>
    </div>
    <div id="view-view">
      <script type>
        // Create the iframe
        var iframe = document.createElement('iframe');
        iframe.id = 'view-iframe';

        // Listen for messages from the iframe
        iframe.onload = function () {
          iframe.contentWindow.addEventListener('message', event => {
            // Detect if iframe is self
            if (event.source !== iframe.contentWindow) {
              return;
            }
            send("^" + JSON.stringify(event.data));
          });
        };

        // Append iframe to document body
        $("#view-view")[0].appendChild(iframe);
      </script>
    </div>

    <div id="editor-options">
      <button class="btn btn-sm btn-info" id="editor-save" onclick="saveClientCode()">Save</button>
      <button class="btn btn-sm btn-success" id="editor-run" onclick="runServerCode()">Run</button>
      <button class="btn btn-sm btn-danger" id="editor-stop" onclick="stopServerCode()">Stop</button>
      <span id="editor-status">status</span>
    </div>
  </div>

  <div class="page" id="home-games-project-join">
  </div>

  <div class="page container mt-5" id="home-build">
    <h3>Build deno project</h3>
    <div class="row">

      <div class="col-md-12">
        <p>Jumpstart your progress by starting from a template. Full explanation and code docs are given in the
          <b>default</b> template.
        </p>
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" id="build-dropdown-toggle" type="button" id="triggerId"
            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Choose template
          </button>
          <button id="build-refresh" class="btn btn-success" onclick="refreshTemplateOptions()">Refresh</button>
          <div id="build-dropdown-menu" class="dropdown-menu" aria-labelledby="triggerId"
            style="height: 300px; overflow-y: scroll;">
            <h6 class="dropdown-header">Basic</h6>
            <div id="template-basic">
            </div>
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">Community</h6>
            <div id="template-community">
            </div>
          </div>
        </div>
      </div>
    </div>
    <h5 class="mt-3">Template:<span id="build-title"></span></h5>
    <form class="row">
      <div class="form-group col-8">
        <label for="build-new-name">New name</label>
        <input type="text" class="form-control" id="build-new-name" placeholder="Project name">
      </div>
      <div class="form-group col-4">
        <label for="build-version">Version</label>
        <input type="text" class="form-control" id="build-version" placeholder="1.0">
      </div>
      <div class="form-group col-12">
        <label for="build-desc">Description</label>
        <!-- Multi-line -->
        <textarea class="form-control" id="build-desc" rows="3"></textarea>
      </div>
      <div class="form-group col-8" style="margin-left: 20px">
        <input class="form-check-input" type="checkbox" value="" id="build-is-template">
        <label class="form-check-label" for="build-is-template">List as Template</label>
      </div>
      <div class="form-group col-12">
        <input type="range" class="custom-range" id="build-max-players" min="2" max="21" value="8"
          onchange="updateMaxPlayers()">
        <label for="build-max-players">Max players - <span id="max-players">8</span></label>
      </div>
    </form>
    <p id="disclaimer" style="border: dotted black 2px; padding: 10px"><b>DISCLAIMER - PLEASE READ </b><br>
      I agree that I will not this app for illegal activities, such as uploading copyrighted content.
      An unsafe app can be removed by a server admin.<br>
      <button onclick="acceptDisclaimer()">I agree</button>
    </p>
    <div class="mb-3">
      <button id="build-back" class="btn btn-dark" onclick="chPage('home')">Back</button>
      <button id="build-create" class="btn btn-primary" disabled onclick="buildProjectFromTemplate()">Create</button>
      <a href="javascript:void(0)" style="float:right" onclick="viewDisclaimer()">View disclaimer</a>
    </div>
  </div>

  <div id="view-stdout"> </div>




  <!-- Popup to share link -->
  <div id="share-popup" class="" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Welcome</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeSharePopup()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>KA Metaverse games are best played with a friend. Share this link with your friends to play together.</p>
          <small>Fullscreen link</small>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="share-link" value="https://kqwq.me/metaverse" readonly>
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" type="button" id="copy-link"
                onclick="copyMetaLink()">Copy</button>
            </div>
          </div>
          <div class="input-group mb-3">
            <!-- Expand Khan Academy options -->
            <details>
              <summary class="mb-3">Run on khanacademy.org</summary>
              <div>
                <textarea readonly id="ka-source-code">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;script&gt;[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]][([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]][([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]((!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+!+[]]+([]+[])[(![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]()[+!+[]+[!+[]+!+[]]]+((!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(![]+[])[+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(+[![]]+[])[+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(![]+[])[+!+[]]+([][[]]+[])[+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+([][[]]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+!+[]]+(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(![]+[])[+!+[]]+([][[]]+[])[!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]]+[+[]]+[+[]]+[+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+([][[]]+[])[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[+!+[]]+[+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+(+[![]]+[])[+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([][[]]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+([][[]]+[])[!+[]+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(+(+!+[]+[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+[!+[]+!+[]]+[+[]])+[])[+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+([][[]]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]+!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]]+[!+[]+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]]+(!![]+[])[+[]]+[!+[]+!+[]+!+[]+!+[]+!+[]]+[+!+[]])[(![]+[])[!+[]+!+[]+!+[]]+(+(!+[]+!+[]+[+!+[]]+[+!+[]]))[(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([]+[])[([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]][([][[]]+[])[+!+[]]+(![]+[])[+!+[]]+((+[])[([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]+[])[+!+[]+[+!+[]]]+(!![]+[])[!+[]+!+[]+!+[]]]](!+[]+!+[]+!+[]+[+!+[]])[+!+[]]+(![]+[])[!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]]((!![]+[])[+[]])[([][(!![]+[])[!+[]+!+[]+!+[]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([![]]+[][[]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]](([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]][([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]((!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+!+[]]+(![]+[+[]])[([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]+(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()[+!+[]+[+[]]]+![]+(![]+[+[]])[([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]+(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()[+!+[]+[+[]]])()[([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]((![]+[+[]])[([![]]+[][[]])[+!+[]+[+[]]]+(!![]+[])[+[]]+(![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+([![]]+[][[]])[+!+[]+[+[]]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(![]+[])[!+[]+!+[]+!+[]]]()[+!+[]+[+[]]])+[])[+!+[]])+([]+[])[(![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]()[+!+[]+[!+[]+!+[]]])())()&lt;/script&gt;&lt;/html&gt;</textarea>
                <div class="mt-2">
                  <ol>
                    <li>Open a <a href="https://www.khanacademy.org/computer-programming/new/webpage">new webpage</a>
                    </li>
                    <li>Copy and paste the code above into the webpage</li>
                  </ol>
                </div>
                <!-- Copy code -->
                <a class="btn btn-primary btn-sm" href="https://www.khanacademy.org/computer-programming/new/webpage"
                  target="_blank">Open webpage</a>
                <button id="btn-copy-code" class="btn btn-secondary btn-sm" onclick="copyCode()">Copy code</button>
              </div>
            </details>
            <!-- Share on twitter -->
            <hr />
            <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kqwq.me/metaverse/"
              data-text="Join me in the KA Metaverse - "> </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } }(document, 'script', 'twitter-wjs');</script>
  <script>
    // When the user clicks on div, open the popup
    function openSharePopup() {
      let popup = $("#share-popup");
      popup.fadeIn();
    }
    if (localStorage.getItem("ka.metaverse:password") === null) {
      let popup = $("#share-popup");
      openSharePopup()
    } else {
      let popup = $("#share-popup");
      popup.hide()
    }
    function closeSharePopup() {
      let popup = $("#share-popup");
      popup.fadeOut();
    }
    function copyMetaLink() {
      var copyText = $("#share-link");
      copyText.select();
      document.execCommand("copy");
      $("#copy-link").text("Copied!");
    }
    function copyCode() {
      var copyText = $("#ka-source-code");
      copyText.select();
      document.execCommand("copy");
      $("#btn-copy-code").text("Copied!");
    }
  </script>






  <!-- SCRIPT.HOME -->
  <script type>
    var myGeo = {
      lat: 0,
      lng: 0
    }
    var serverGeo = {
      lat: 38,
      lng: -77
    }
    // Constants
    var ARC_ANIMATION_DURATION = 500;

    // Time of day
    var hours = new Date().getHours()
    var isDayTime = hours > 6 && hours < 20
    // Points
    var pointsData = []
    function clearPoints() {
      pointsData = []
      globe.pointsData([])
    }
    function addPoint(lat, lng, color, count) {
      var point = {
        lat,
        lng,
        size: Math.sqrt(count) * 0.1,
        color: color || "darkorange"
      }
      pointsData.push(point)
      globe.pointsData(pointsData)
    }

    // Arcs
    var arcsData = []
    function addArc(startLat, startLng, endLat, endLng, color1, color2, onTouchdown) {
      function updateArcData() {
        let diff = false
        let dateNow = new Date().getTime()
        for (var i = arcsData.length - 1; i >= 0; i--) {
          if (dateNow - arcsData[i].created > ARC_ANIMATION_DURATION * 2 - 100) { // Remove old arcs
            arcsData.splice(i, 1);
            diff = true
          }
        }
        if (diff) {
          globe.arcsData(arcsData)
        }
      }
      var arc = {
        startLat,
        startLng,
        endLat,
        endLng,
        color: [color1, color2],
        created: new Date().getTime(),
      }
      arcsData.push(arc)
      globe.arcsData(arcsData)
      setTimeout(onTouchdown, ARC_ANIMATION_DURATION)
      setTimeout(updateArcData, ARC_ANIMATION_DURATION * 2)
    }

    var globeImages = {
      day: 'https://upload.wikimedia.org/wikipedia/commons/c/c3/Solarsystemscope_texture_2k_earth_daymap.jpg',
      night: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/BlackMarble20161km.jpg/2200px-BlackMarble20161km.jpg',
      earth2: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Blue_Marble_2002_bg21600.png/2560px-Blue_Marble_2002_bg21600.png',
      sun: 'https://upload.wikimedia.org/wikipedia/commons/c/cb/Solarsystemscope_texture_2k_sun.jpg',
      moon: 'https://upload.wikimedia.org/wikipedia/commons/2/26/Solarsystemscope_texture_2k_moon.jpg',
      mars: 'https://upload.wikimedia.org/wikipedia/commons/4/46/Solarsystemscope_texture_2k_mars.jpg',
      night2: 'https://upload.wikimedia.org/wikipedia/commons/2/2f/Solarsystemscope_texture_2k_earth_nightmap.jpg',
      venus: 'https://upload.wikimedia.org/wikipedia/commons/6/63/Solarsystemscope_texture_2k_venus_atmosphere.jpg',
      venus2: 'https://upload.wikimedia.org/wikipedia/commons/4/40/Solarsystemscope_texture_2k_venus_surface.jpg',
      ceres: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Solarsystemscope_texture_2k_ceres_fictional.jpg',
      eris: 'https://upload.wikimedia.org/wikipedia/commons/3/36/Solarsystemscope_texture_2k_eris_fictional.jpg',
      saturn: 'https://upload.wikimedia.org/wikipedia/commons/e/ea/Solarsystemscope_texture_2k_saturn.jpg',
      uranus: 'https://upload.wikimedia.org/wikipedia/commons/9/95/Solarsystemscope_texture_2k_uranus.jpg',
      neptune: 'https://upload.wikimedia.org/wikipedia/commons/1/1e/Solarsystemscope_texture_2k_neptune.jpg',
      stars: 'https://upload.wikimedia.org/wikipedia/commons/6/6a/Solarsystemscope_texture_2k_stars.jpg',
      milkyway: 'https://upload.wikimedia.org/wikipedia/commons/0/0e/Solarsystemscope_texture_2k_stars_milky_way.jpg',
      outline: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/db/Solarsystemscope_texture_2k_earth_specular_map.tif/lossy-page1-2048px-Solarsystemscope_texture_2k_earth_specular_map.tif.jpg',
      clouds: 'https://upload.wikimedia.org/wikipedia/commons/e/ed/Solarsystemscope_texture_2k_earth_clouds.jpg'
    }

    var globe = Globe()
      .globeImageUrl(isDayTime ? globeImages.day : globeImages.night)
      .showAtmosphere(1)
      .atmosphereColor(isDayTime ? 'navyblue' : 'black')
      .backgroundColor(isDayTime ? '#B7CFE3' : '#1B2631')

      .onGlobeClick((d, e) => {
        addArc(myGeo.lat, myGeo.lng, serverGeo.lat, serverGeo.lng, '#ff0000', '#ff0000', () => {
          addArc(serverGeo.lat, serverGeo.lng, d.lat, d.lng, '#ff0000', '#ff0000')
        })

      })
      .onGlobeRightClick(() => {
        let randomImage = Object.values(globeImages)[Math.floor(Math.random() * Object.values(globeImages).length)]
        globe.globeImageUrl(randomImage)
      })
      .pointsData(pointsData)
      .pointAltitude('size')
      .pointColor('color')
      .arcsData(arcsData)
      .arcColor('color')
      .arcDashLength(1)
      .arcDashGap(100)
      .arcDashInitialGap(1)
      .arcDashAnimateTime(ARC_ANIMATION_DURATION)
      .arcsTransitionDuration(0)
      ($("#globeViz")[0]);

    globe.controls().autoRotate = true;

    addPoint(myGeo.lat, myGeo.lng, '#00ff00')

    function putInstructions(buttonName) {
      let instructions = {
        undefined: '',
        login: "Login in using your Khan Academy account",
        enter: "Enter the KA metaverse and choose from a list of games",
        build: "Create up to 5 Deno projects (must be logged in)",
      }
      $("#home-instructions")[0].innerHTML = instructions[buttonName]
    }

    function hideGraphics(chColor) {
      if (chColor) {
        $("#btn-container")[0].style['background-color'] = '#0a082e'
        globe = null // Garbage collect
      }
      $("#white-screen")[0].style.display = 'none'
    }

  </script>

  <!-- SCRIPT.LOGIN -->
  <script type>
    var uid = ""
    var oh = "incognito"
    var bioChangePIN = "error";
    var ppAnimation = 1;
    var ppAnimationTarget = 1;
    var ppShown = true;
    var ppu = $("#pp-username")[0]
    function ppShow() { // Show pp card and show small username input
      $("#btn-login-as")[0].disabled = false;
      $("#bio-change-container")[0].style.display = "none";
      ppAnimationTarget = 0;
    }
    function ppHide() { // Hide pp card and show large username input
      ppAnimationTarget = 1
    }
    function getPPUValue() {
      // Remove non-alphanumeric/underscore characters
      ppu.value = ppu.value.replace(/[^a-zA-Z0-9_]/g, "");
      return ppu.value
    }
    var usernameBlocking = false;
    var fetchingUsername = ""
    function fetchUsername() { // Show pp card if username input is focused

      if (usernameBlocking || fetchingUsername == getPPUValue()) {
        return
      }
      fetchingUsername = getPPUValue();
      if (fetchingUsername.length < 3) {
        ppHide()
        return;
      }
      usernameBlocking = true;

      send("!get-ka-profile " + fetchingUsername)
    }
    function logInAs() {
      $("#btn-login-as")[0].disabled = true;
      $("#bio-change-container")[0].style.display = "block";
      $("#bio-add-pin")[0].textContent = bioChangePIN;
      let txt = $("#pp-bio")[0].textContent
      // Make sure bio contains the PIN
      txt = `<b>New bio: </b>${txt.slice(0, 160 - bioChangePIN.length)}<span>${bioChangePIN}</span>`
      $("#pp-bio")[0].innerHTML = txt
    }
    function verifyBioChange() {
      $("#btn-verify")[0].disabled = true;
      send(`!sign-up-with-bio-pin ${oh || localStorage.getItem("ka.metaverse:offerHash")}`)
    }

    function ppKeyframe(p) { // p = percentage of animation
      ppu.style.border = `${p < 0.1 ? 0 : 3 * p}px solid rgba(204, 204, 204, ${p})`;
      ppu.style["font-size"] = `${16 + 14 * p}px`;
      ppu.style.width = `${p < 0.5 ? "" : (85 * p * p) + "%"}`;
      ppu.style.height = `${p < 0.5 ? "" : (50 * p) + "px"}`;
      ppu.style.padding = `${20 * p}px`
      ppu.style["border-radius"] = "5px";
      if (p > 0.5) {
        ppu.style.marginLeft = `${600 * (1 - p)}px`
        if (ppShown) {
          ppShown = false;
          ppu.style.marginTop = "40px"
          $("#home-login")[0].appendChild(ppu)
          $("#pp")[0].style.display = "none";
          $("#btn-login-as")[0].style.display = "none";
          $("#bio-change-container")[0].style.display = "none";
          ppu.focus()
        }
      } else {
        if (!ppShown) {
          ppShown = true;
          ppu.style.marginLeft = "0px";
          ppu.style.marginTop = "0px"
          $("#pp-username-container")[0].appendChild(ppu)
          $("#pp")[0].style.display = "flex";
          $("#btn-login-as")[0].style.display = "block";
          ppu.focus()
        }
      }
    }
    ppHide()
    ppKeyframe(1)
    setInterval(() => {
      if (page === "home-login") {///
        if (ppAnimation == ppAnimationTarget) {
          return
        } else if (Math.abs(ppAnimation - ppAnimationTarget) < 0.001) {
          ppAnimation = ppAnimationTarget;
          ppKeyframe(ppAnimation)
        } else {
          ppAnimation += (ppAnimationTarget - ppAnimation) * 0.07;
          ppKeyframe(ppAnimation)
        }
      }
    }, 1000 / 50) // 50 fps

    function chName() {
      let name = prompt("Enter your name: ")
      if (name == null) {
        return
      }
      name = name.trim()
      console.log(name, "hello");
      send("!change-guest-uid " + name)
      // Show login button
      $("#btn-login")[0].style.display = "block";
      $("#edit-name")[0].innerHTML = "edit name"
    }

  </script>

  <script type>{
      { }// highlighting fixed in vscode

      // SCRIPT.GAMES
      var editorStatusCountup = -1;

      // Views setup
      var view = 'server'
      function chView(newView) {
        var views = $("#kam-views")[0].getElementsByTagName('a');
        for (var i = 0; i < views.length; i++) {
          views[i].className = '';
          document.getElementById("view-" + views[i].id).style.display = 'none';
        }
        document.getElementById(newView).className = 'active';
        document.getElementById("view-" + newView).style.display = 'block';

        terminalActive = false;
        if (newView == 'view') {
          runHtmlCode()
        } else if (newView == 'stdout') {
          terminalActive = true;
        }
        view = newView;
      }

      // Create/set project
      var projects = []
      var myProject = {}
      var projectServerCode = ""
      var projectClientCode = ""
      function getProjects() {
        // Wipe build page templates
        $("#build-refresh")[0].disabled = true;
        let templateBasic = $("#template-basic")[0];
        let templateCommunity = $("#template-community")[0];
        templateBasic.innerHTML = '';
        templateCommunity.innerHTML = ''

        $("#game-list")[0].innerHTML = '<div>Loading<span class="loading"></span></div>' // Game page loading

        // Send request
        send("!deno-get-projects")
      }
      function populateProjects() {
        let denoListHtml = ""
        // Sort by view count
        let getScore = (proj) => proj.players.length * 100000 + Number(proj.author == uid) * 99999
        projects.sort((a, b) => {
          return getScore(b) - getScore(a)
        })
        for (let p of projects) {
          denoListHtml += `
<div class="game-item">
  <div>
    <a class="game-item-title" href="javascript:void(0)" onclick="aboutProject('${p.name}')">
      ${p.name}
    </a>
    <span class="badge badge-pill badge-primary">${p.players.length || ""}</span>
  </div>
  <div class="game-item-description">
    <p>
      ${p.desc.length > 100 ? p.desc.slice(0, 90) + "..." : p.desc}
    </p>
  </div>
  <div class="game-item-actions">
    <a href="javascript:void(0)" class="btn btn-primary" onclick="joinProject('${p.name}')">Join</a>
    <a href="javascript:void(0)" class="btn btn-${p.author === uid ? "dark" : "secondary"}" onclick="editProjectButton('${p.name}')">${p.author === uid ? "Edit" : "View"}</a>
  </div>
</div>
      `
        }
        $("#game-list")[0].innerHTML = denoListHtml
      }
      function searchGames() {
        let search = $("#games-search")[0].value.toLowerCase()
        $(".game-item").each(function () {
          let gameName = $(this).find(".game-item-title").text().toLowerCase()
          if (gameName.includes(search)) {
            $(this).show()
          } else {
            $(this).hide()
          }
        })
      }
      function updateMaxPlayers() {
        let val = $("#build-max-players")[0].value
        if (val == 21) val = 100
        $("#max-players")[0].textContent = val
      }
      function aboutProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        // Update html
        $("#kam-proj-title")[0].textContent = myProject.name;
        $("#kam-proj-desc")[0].textContent = myProject.desc;
        $("#kam-proj-version")[0].textContent = myProject.version;
        $("#kam-proj-author")[0].textContent = myProject.author;
        $("#kam-proj-views")[0].textContent = myProject.views;
        $("#kam-proj-is-template")[0].checked = myProject.isTemplate;
        $("#kam-proj-max-players")[0].textContent = myProject.maxPlayers || 100;

        // Disable buttons and stdout view if you're not the author
        let disableBtns = myProject.author !== uid;
        $("#kam-proj-save")[0].disabled = disableBtns;
        $("#kam-proj-edit")[0].innerHTML = disableBtns ? 'Edit (view only)' : 'Edit';
        $("#kam-proj-delete")[0].disabled = disableBtns;
        $("#editor-save")[0].disabled = disableBtns;
        $("#editor-run")[0].disabled = disableBtns;
        $("#editor-stop")[0].disabled = disableBtns;
        $("#stdout")[0].style['pointer-events'] = disableBtns ? 'none' : 'auto';

        // Disable editors
        editorHtml?.setReadOnly(disableBtns);
        editorServer?.setReadOnly(disableBtns);

        // Editor options text
        $("#editor-status")[0].textContent = disableBtns ? 'No edit access' : 'Not running';

        chPage('home-games-project');
      }
      function joinProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        chPage('home-games-project-join')
        iframe.srcdoc = "Loading..."
        $("#home-games-project-join")[0].appendChild(iframe) // Move iframe to home-games-project-join page
        send("!join-game " + myProject.name)
      }
      function leaveProject() {
        send("!leave-game")
        chPage('home-games-project')
      }
      function updateProjectInfo() {
        function alphanumericOrDashFilter(str) {
          return str.replace(/\W/g, '-').replace(/[^a-z0-9-]/gi, '');
        }
        myProject = {
          name: myProject.name,
          desc: $("#kam-proj-desc")[0].textContent.slice(0, 1024), // Shorten
          version: $("#kam-proj-version")[0].textContent.slice(0, 20),
          author: uid,
          isTemplate: $("#kam-proj-is-template")[0].checked,
          lastUpdated: Date.now(),
          players: [],
          maxPlayers: $("#kam-proj-max-players")[0].textContent,
        }
        aboutProject();
        send("!deno-update-info " + JSON.stringify(myProject))
      }
      function editProjectButton(projName) {
        if (window.ace) {
          editProject(projName)
        } else {
          console.log("Importing ace editor")
          importAceEditor()
          setTimeout(() => {
            if (ace) {
              initEditors()
              editProject(projName)
              console.log("Imported ace editor")
            } else {
              console.log("Failed to import ace editor")
            }
          }, 1000)
        }
      }
      function editProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        if (!myProject) {
          alert("Project not found")
          return
        }
        aboutProject();
        chPage('home-games-project-edit');
        projectServerCode = "Loading..."
        projectClientCode = "Loading...";
        editorServer.getSession().setValue("Loading...");
        send("!deno-get-code " + myProject.name);
      }
      function deleteProject() {
        let r = confirm("Are you sure you want to delete this project?")
        if (r) {
          send("!deno-delete-project " + myProject.name)
          chPage('home-games');
        }
      }

      function runServerCode() {
        editorStatusCountup = 0;
        let serverCode = editorServer.getSession().getValue();
        let obj = {
          project: myProject.name,
          code: serverCode
        }
        send("!deno-save-and-run-server " + JSON.stringify(obj));
        $("#editor-status")[0] = "Starting..."
      }
      function stopServerCode() {
        send("!deno-kill")
      }
      function runHtmlCode() {
        var htmlCode = editorHtml.getValue();
        iframe.srcdoc = htmlCode; // iframe is global
      }
      function saveClientCode() {
        $("#editor-save")[0].disabled = true
        let clientCode = editorHtml.getSession().getValue();
        let obj = {
          project: myProject.name,
          code: clientCode
        }
        send("!deno-save-client " + JSON.stringify(obj));
      }

      // Make editor-options draggable
      dragElement($("#editor-options")[0]);

      function dragElement(elmnt) { // Source: https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_draggable
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "header")) {
          document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
        } else {
          elmnt.onmousedown = dragMouseDown;
        }
        function dragMouseDown(e) {
          e = e || window.event;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
          elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }


      // Editor setup
      var editorHtml
      var editorServer
      function initEditors() {
        // HTML editor
        let sharedSettings = {
          theme: "ace/theme/tomorrow_night",
          fontSize: "10pt",
          enableBasicAutocompletion: true,
          enableSnippets: true,
          enableLiveAutocompletion: true,
          displayIndentGuides: true,
          tabSize: 2,
          useSoftTabs: true
        }
        editorHtml = ace.edit("view-html");
        editorHtml.setTheme("ace/theme/tomorrow_night");
        editorHtml.setOptions(sharedSettings);
        editorHtml.session.setMode("ace/mode/html");

        // Server editor
        editorServer = ace.edit("view-server");
        editorServer.setOptions(sharedSettings);
        editorServer.session.setMode("ace/mode/javascript");
      }

      function importAceEditor() {
        let element = document.createElement('script');
        element.src = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js';
        document.body.appendChild(element);

        element = document.createElement('script');
        element.href = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ext-language_tools.min.js';
        document.body.appendChild(element);
      }

      // Page setup
      var page = "home"
      function chPage(newPage) {
        // If old page was home-games-project-join, leave it
        console.log("old page: " + page, "new page: " + newPage)
        if (page === "home-games-project-join" && newPage !== "home-games-project-join") {
          console.log("Leaving project join page")
          send("!leave-game")
        }
        function breadcrumbTextView(s) {
          s = s[0].toUpperCase() + s.slice(1)
          return s.replace("Edit", "edit").split("-").map(s => s.replace("Project", myProject.name))
        }
        document.getElementById(page).style.display = "none";
        page = newPage
        document.getElementById(page).style.display = "block";
        let fullPath = ""
        $("#kam-breadcrumbs")[0].innerHTML = page.split("-").map(s => {
          fullPath += s + "-"
          return `<a href="javascript:void(0)" onclick='chPage("${fullPath.slice(0, fullPath.length - 1)}")'>${breadcrumbTextView(s)}</a>`
        }).join(" &gt; ")

        // Special rules
        if (page === "home") {
          if (isConnected) send("!globe")
          $("#view-stdout")[0].style.display = "none";
          $("#kam-views")[0].style.display = "none";
        } else if (page === "home-build") {
          if (!uid || uid.includes('-')) {
            alert("Log into your Khan Academy account to create projects.")
            chPage("home")
            return
          }
        } else if (page == "home-games-project-edit") {
          $("#kam-views")[0].style.display = "inline";
          chView("html");
          $("#view-view")[0].appendChild(iframe); // Move iframe to home-games-project-edit page
        } else {
          $("#kam-views")[0].style.display = "none";
          terminalActive = false;
          editorStatusCountup = -1;
          $("#view-stdout")[0].style.display = "none";
          $("#btn-verify")[0].disabled = false;
        }

      }
      document.querySelectorAll(".page").forEach(v => v.style.display = "none") // Hide all pages
      setTimeout(() => chPage("home"), 0)


      function send(ele) {
        if (!isConnected) {
          alert("You are not connected")
          return
        }
        peer.send(ele)
      }

      var terminalActive = false
      function onRecieve(data) {
        if (data.startsWith("~")) {
          console.log("%c" + data, 'background: #000; color: #00ff00')
          // Send message to terminal if it is open
          if (page === "home-games-project-edit") {
            term.write(data.slice(1).replace(/\x07/g, "\x1b[31m[DEBUG]\x1b[0m ").replace(/\n/g, "\r\n"))
          }
          return
        }
        if (data.startsWith("^")) {
          // Send message to terminal if it is open
          if (page == "home-games-project-edit") {
            term.write(data.replace(/\n/g, "\r\n") + "\r\n")
          }

          // Also send message to iframe
          iframe?.contentWindow?.postMessage(data.slice(1), '*');
          return
        }

        console.log("%c" + data, 'background: #000; color: #ff00ff')
        let [firstArg, secondArg] = data.split(/ (.+)/s)
        if (firstArg === "ping") {
          send("!pong")
        } else if (firstArg === "alert") {
          alert(secondArg)
        } else if (firstArg === "leave-room") {
          if (page === "home-games-project-join") {
            iframe.srcdoc = "";
            chPage("home")
          }
        } else if (firstArg == "deno-terminal-end") {
          if (page === "home-games-project-edit") {
            editorStatusCountup = -1;
            let statusCode = secondArg
            $("#editor-status")[0].textContent = `Exit code ${statusCode}`
          } else if (page === "home-games-project-join") {
            iframe.srcdoc = "";
            leaveProject()
            alert("Game crashed on server")
          }
        } else if (firstArg === "deno-save-client-success") {
          $("#editor-save")[0].disabled = false // enable button
        } else if (firstArg == "geo") {
          let geoData = JSON.parse(data.slice(4))
          /// TODO not used
        } else if (firstArg === 'deno-set-projects') {
          projects = JSON.parse(secondArg)
          populateProjects()
          populateTemplateOptions();
        } else if (firstArg === 'deno-set-server') {
          projectServerCode = secondArg
          editorServer.getSession().setValue(projectServerCode)
        } else if (firstArg === 'deno-set-client') {
          projectClientCode = secondArg
          editorHtml.getSession().setValue(projectClientCode)
        } else if (firstArg === 'set-iframe') {
          iframe.srcdoc = secondArg
        } else if (firstArg === 'deno-add-project') {
          myProject = JSON.parse(secondArg)
          if (myProject.prevName) {
            projects = projects.filter(p => p.name != myProject.prevName)
          }
          projects.push(myProject)
          populateProjects()
          aboutProject()
        } else if (firstArg === 'deno-remove-project') {
          removedProjectName = secondArg
          projects = projects.filter(p => p.name != removedProjectName)
          populateProjects()
        } else if (firstArg === 'set-uid') {
          uid = secondArg
          $("#logged-in-as-container")[0].style.display = "block"
          $("#logged-in-as")[0].innerText = uid
          $("#kam-status")[0].textContent = ""
          localStorage.setItem("ka.metaverse:uid", uid)
        } else if (firstArg === 'set-password') {
          localStorage.setItem("ka.metaverse:password", secondArg)
        } else if (firstArg === 'globe') {
          if (page === "home") {
            let globeData = JSON.parse(secondArg)
            let statusColors = {
              "online": "orange",
              "playing": "green",
              "offline": "gray",
              "self": "magenta"
            }
            clearPoints()
            for (let gd of globeData) {
              addPoint(gd.lat, gd.lng, statusColors[gd.status || "offline"], gd.count)
              if (gd.status === "self") {
                myGeo = { lat: gd.lat, lng: gd.lng }
              }
            }
          }
        } else if (firstArg === "get-ka-profile") {
          usernameBlocking = false;
          if (secondArg === "error") {
            ppHide()
          } else {
            let json = JSON.parse(secondArg)
            $("#pp-real-name")[0].textContent = json.nickname;
            $("#pp-avatar")[0].src = json.avatarSrc;
            $("#pp-bio")[0].textContent = json.bio;
            $("#pp-ep")[0].textContent = json.points ? "?" : "+" + json.points.toLocaleString()
            $("#login-as-username")[0].textContent = fetchingUsername
            bioChangePIN = json.pin
            ppShow()
          }
          fetchUsername()
        } else if (firstArg === "sign-up-with-bio-pin") {
          $("#btn-verify")[0].disabled = false;
          alert("Success! You can now log in as " + fetchingUsername + " automatically.")
          // Remove login button on home page
          $("#btn-login")[0].style.display = "none"
          $("#edit-name")[0].innerHTML = "log out"
          chPage("home")
        } else if (firstArg === "auto-login") {
          if (secondArg === "error") {
            $("#kam-status")[0].textContent = "Auto-login failed"
            send(`!get-guest-uid`)
          } else if (secondArg === "success") {
            // Remove login button on home page
            $("#btn-login")[0].style.display = "none"
            $("#edit-name")[0].innerHTML = "log out"
          }
        }
      }


      var serverIp = "173.79.147.118"
      var linkId = "5918360080531456"

      // Create 4-byte fingerprint and use that as answer line number
      var randomFingerprint = Math.random().toString(16).substring(2, 6)
      var answerLineNumber = parseInt(randomFingerprint.slice(0, 2), 16)
      var peer = null
      var isConnected = false

      connectToServer()
      function connectToServer() {


        parent?.peer?.destroy()
        peer = new SimplePeer({
          initiator: true,
          trickle: false,
          config: {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }]
          },
        }).on("signal", function (data) {
          console.log("%cCopy for manual input", "background: #000; font-size: x-large")
          console.log("%c" + "SDP_" + randomFingerprint + "_" + btoa(data.sdp), 'background: #000; color: #00ff00')
          $("#not-connected")[0].style.display = "none"
          $("#kam-status")[0].innerHTML = 'Connecting<span class="loading"></span>'
          sendSdpPackets(JSON.stringify(data))
        }).on("connect", function () {
          isConnected = true
          onServerConnected()
        }).on("data", function (data) {
          onRecieve(data.toString())
        }).on("close", function () {
          isConnected = false
          $("#kam-status")[0].textContent = "Disconnected"
          $("#not-connected")[0].style.display = "block"
        }).on("error", function (err) {
          $("#kam-status")[0].textContent = "Error - open console";
          console.log("error", err)
        })
        parent.peer = peer

        function sendSdpPackets(content) {
          // PACKET FORMAT: 37cfa9{"type":"offer","sdp":"v=0\r\no...
          /** Breakdown
           *  - (1 char)    packet index (3=4th packet in hex)
           *  - (1 char)    number of packets (7=8 in hex), in case packets are received out of order
           *  - (4 chars)   packet fingerprint/identifier (example: cfa9)
           *  - (494 chars) packet content
           * 
           * In technical terms this has nothing to do with a network packet
           */
          let hex = "0123456789abcdef"
          let packetSize = 494
          if (content.length >= packetSize * 16) {
            $("#kam-status")[0].textContent = "SDP offer too long to send";
            console.error("SDP offer too long")
            return
          }

          // Split up sdp data into up to 16 packets
          let packets = []
          for (let i = 0; i < content.length; i += packetSize) {
            packets.push(content.substr(i, packetSize))
          }

          // Send packets with header and index
          for (let i = 0; i < packets.length; i++) {
            let packet = hex[i] + hex[packets.length] + randomFingerprint + packets[i]
            sendToTurnServer(packet)
          }
          console.log(`Sent ${packets.length} packets with fingerprint ${randomFingerprint}`)

          setTimeout(attemptConnection, 2000)
        }

        function sendToTurnServer(content) {
          const pc = new RTCPeerConnection({
            iceServers: [{
              urls: [`turn:${serverIp}:3478`],
              username: content,
              credential: "1"
            }],
            iceCandidatePoolSize: 1
          })
          setTimeout(() => pc.close(), 1000)
        }
      }

      let connectionAttemptsMax = 6
      let connectionAttempts = 0
      function attemptConnection() {
        $("#kam-status")[0].textContent = `Connecting (${connectionAttempts}/${connectionAttemptsMax})`
        console.log('Attempting to connect...');
        let url = `https://www.khanacademy.org/api/internal/scratchpads/${linkId}?callback=?`
        $.getJSON(url, data => {
          if (data == null) {
            $("#kam-status")[0].innerHTML = "Link Program deleted - contact Squishy.";
            console.error("Connection error: Link Program was likely deleted. Please contact Squishy.")
            return
          }
          let linkProgramCode = data.revision.code.split('\n')
          let linkLastUpdated = new Date(data.revision.created)
          let nowDate = new Date()
          let diff = nowDate - linkLastUpdated
          let diffSeconds = Math.floor(diff / 1000)
          let diffHours = Math.floor(diff / (1000 * 60 * 60))

          // Detect a signal answer to my offer

          let serverOffer = linkProgramCode[answerLineNumber - 1]
          if (!serverOffer || !serverOffer.includes('answer=')) {
            connectionAttempts++
            if (connectionAttempts > connectionAttemptsMax) {
              $("#kam-status")[0].textContent = "Server offline - contact Squishy."
              console.error("Connection error: Link Program is unresponsive. Please contact Squishy.")
              return
            }
            setTimeout(attemptConnection, 1000) // Wait 1 second and try again
            return
          }

          serverOffer = serverOffer.split(/\=(.+)/)[1] // Remove offerAnswer=
          peer.signal(serverOffer)
        })

      }

      function onServerConnected() {
        $("#kam-status")[0].textContent = ""

        // Wait 0.5 seconds to make sure the server has time to connect
        setTimeout(() => {
          getProjects()
          send("!globe") // Get globe data

          // Auto-login or create guest account
          try {
            uid = localStorage.getItem("ka.metaverse:uid")
            var password = localStorage.getItem("ka.metaverse:password")
            oh = localStorage.getItem("ka.metaverse:offerHash")
            localStorage.setItem("ka.metaverse:offerHash", oh || Math.random().toString())
          } catch (e) {
            console.log("LocalStorage is not available, which is OK")
          }
          if (uid && password && !uid.includes("-")) { // If uid has dash, it's a default guest/custom guest account
            $("#kam-status")[0].innerHTML = 'Logging in<span class="loading"></span>'
            send(`!auto-login ${uid} ${password} ${oh}`) // Login to the server
          } else {
            send(`!get-guest-uid ${oh}`) // Get guest (temporary) username for those who don't log in yet
          }
        }, 500)

        // Wait 1.0 seconds to make sure the server has time to auto-login
        setTimeout(() => {
          // Window URL
          const urlSearchParams = new URLSearchParams(window.location.search);
          const params = Object.fromEntries(urlSearchParams.entries());
          if (params.join) {
            joinProject(params.join)
          } else if (params.edit) {
            editProjectButton(params.edit)
          }
        }, 1000)
      }

      // Update loading ellipsis
      setInterval(() => {
        document.querySelectorAll(".loading").forEach(ele => {
          ele.innerHTML += "."
          if (ele.innerHTML.length > 3) {
            ele.innerHTML = ""
          }
        })
      }, 250)

      // If terminal is active, increment the editor-status countup
      setInterval(() => {
        if (editorStatusCountup >= 0) {
          editorStatusCountup += 1
          let hours = Math.floor(editorStatusCountup / 3600)
          let minutes = Math.floor((editorStatusCountup - hours * 3600) / 60)
          let seconds = Math.floor(editorStatusCountup - hours * 3600 - minutes * 60)
          $("#editor-status")[0].textContent = `${hours}h ${minutes}m ${seconds}s`
        }
      }, 1000)




    }

  </script>

  <script type>
    // SCRIPT.BUILD
    // Detect dropdown selection without jQuery
    var dropdown = $("#build-dropdown-menu")[0];
    $("#build-dropdown-toggle")[0].addEventListener('click', function () {
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    function onTemplateSelect(projName) {
      let projectMatch = projects.find(proj => proj.name == projName)
      $("#build-title")[0].innerHTML = projName;
      $("#build-version")[0].value = projectMatch.version
      $("#build-desc")[0].value = `Based on ${projName}`
    }
    function acceptDisclaimer() {
      $("#disclaimer")[0].style.display = 'none';
      $("#build-create")[0].disabled = false;
    }
    function viewDisclaimer() {
      $("#disclaimer")[0].style.display = 'block';
      window.scrollTo(0, 0);
    }
    function populateTemplateOptions() {
      $("#build-refresh")[0].disabled = false;
      let templateBasic = $("#template-basic")[0];
      let templateCommunity = $("#template-community")[0];
      projects.filter(proj => proj.isTemplate).forEach(function (proj) {
        let option = document.createElement('a');
        option.className = 'dropdown-item';
        option.href = '#';
        option.textContent = proj.name;
        let templateOptions = proj.isBasicTemplate ? templateBasic : templateCommunity;
        templateOptions.appendChild(option);
      });

      document.querySelectorAll('#build-dropdown-menu a').forEach(function (element) {
        element.addEventListener('click', function () {
          dropdown.style.display = 'none';
          let name = element.textContent;
          onTemplateSelect(name);
        });
      });
    }
    function buildProjectFromTemplate() {
      let projBasedOn = $("#build-title")[0].innerHTML;
      let projName = $("#build-new-name")[0].value;
      let projVersion = $("#build-version")[0].value;
      let projDesc = $("#build-desc")[0].value;
      let projIsTemplate = $("#build-is-template")[0].checked;
      let projMaxPlayers = $("#build-max-players")[0].value;
      if (projName == '') {
        alert('Project name cannot be empty');
        return;
      }
      if (projects.find(proj => proj.name == projName)) {
        alert('Project name already exists');
        return;
      }
      if (projBasedOn == '') {
        alert('Please select a template');
        return;
      }
      let projObj = {
        basedOn: projBasedOn,
        name: projName,
        desc: projDesc,
        version: projVersion,
        isTemplate: projIsTemplate,
        maxPlayers: projMaxPlayers
      };
      send('!deno-create-project ' + JSON.stringify(projObj));
    }
  </script>
  <script type>
    var term = new Terminal({
      cursorBlink: true,
      cols: 65,
      rows: 19,
    });
    var fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    fitAddon.fit();
    term.open($("#view-stdout")[0]);
    term.nextLine = function () {
      term.write('\r\nmetaverse $ ');
    };
    term.prompt = () => {
      term.write('\n')
      if (term.currLine == "cls" || term.currLine == "clear") {
        term.clear()
      } else if (term.currLine == "help\r") {
        term.nextLine()
      } else {
        send("^" + term.currLine.toString().trim()) // todo only send if server is not running
      }
      term.currLine = "";
    };
    term.currLine = "";
    term.write('metaverse $ ')
    term.onKey(e => {
      if (e.key === "Backspace") { // Backspace
        term.write('\b \b');
        term.currLine = term.currLine.slice(0, -1);
      } else if (e.key === '\r') { // Enter
        term.write('\r\n');
        term.prompt()
      } else {
        term.currLine += e.key;
        term.write(e.key);
      }
    })
    // Set theme to xterm.js
    term.setOption('theme', {
      "name": "Atom",
      "black": "#000000",
      "red": "#fd5ff1",
      "green": "#87c38a",
      "yellow": "#ffd7b1",
      "blue": "#85befd",
      "purple": "#b9b6fc",
      "cyan": "#85befd",
      "white": "#e0e0e0",
      "brightBlack": "#000000",
      "brightRed": "#fd5ff1",
      "brightGreen": "#94fa36",
      "brightYellow": "#f5ffa8",
      "brightBlue": "#96cbfe",
      "brightPurple": "#b9b6fc",
      "brightCyan": "#85befd",
      "brightWhite": "#e0e0e0",
      "background": "#161719",
      "foreground": "#c5c8c6",
      "selectionBackground": "#444444",
      "cursorColor": "#d0d0d0"
    });
    $("#view-stdout")[0].style.display = 'none';
  </script>
  <script></script>
</body>

</html>