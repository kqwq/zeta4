<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Progress</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.0/simplepeer.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/globe.gl@2.22.8/dist/globe.gl.min.js"></script>

  <!-- Ace cdn from jsDelivr -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript"
    charset="utf-8"></script>
  <style>
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
      border-radius: 10px;
    }

    /* STYLE.HOME */
    #home-instructions-container {
      background-color: rgba(0, 0, 0, 0.3);
      z-index: 2;
      position: absolute;
      left: 10px;
      bottom: 10px;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      color: white;
      font-family: monospace;
    }

    #logged-in-as {
      color: gray;
    }

    .btn-glass {
      /* Translucent background, white text, set border, rounded corners */
      pointer-events: auto;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 16px;
      font-weight: bold;
      padding: 10px;
      margin: 24px;
      cursor: pointer;
      z-index: 2;
      /* Make text non-selectable */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    button:hover {
      background-color: rgba(255, 255, 255, 0.4);
    }

    #btn-container {
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      /* Align buttons to center */
      text-align: center;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }

    /* STYLE.LOGIN */
    #home-login {
      background-color: rgb(253, 253, 253);
      position: absolute;
      top: 0;
      left: 0;
      width: 95%;
      height: 95%;
      margin: 20px;
    }

    #home-login b {
      color: blue;
    }

    #home-login button {
      margin: 10px;
    }

    #pp {
      font-family: Arial;
      margin-top: 30px;
      width: 380px;
      border: 1px solid rgb(204, 204, 204);
      border-radius: 7px;
      padding-left: 10px;
      box-shadow: 0px 0px 5px rgb(204, 204, 204);
      padding: 15px 21px;

      /* Align items left to right, pinned to top (Thanks GitHub Copilot) */
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    #pp img {
      width: 64px;
    }

    #pp>div {
      margin-left: 15px;
      min-width: 0;
    }

    #pp-names {
      display: flex;
      align-items: center;
    }

    #pp-names * {
      margin: 0;
      padding: 0;
    }

    #pp-real-name {
      font-size: 20px;
      font-weight: bold;
      white-space: nowrap;
    }

    #pp-username-container {
      display: inline-flex;
      margin-left: 3px;
      color: #9E9FA2;
      font-size: 16px;
      font-weight: normal;
      min-width: 0;
    }

    #pp-username {
      color: #9E9FA2;
      font-size: 16px;
      font-weight: normal;
      /* Strip styling from input */
      border: none;
      background: none;
      outline: none;
    }

    #pp-bio {
      font-size: 16px;
    }

    #pp-ep {
      color: #0A2A66;
      font-weight: bold;
      font-size: 16px;
      float: right;
    }

    /* STYLE.REST */
    .toolbar {
      background-color: rgba(252, 252, 252, 0.9);
      position: absolute;
      top: 0px;
      left: 0px;
      padding: 1px;
      width: 100%;
      font-size: 15px;
      z-index: 999;
      height: 20px;
      line-height: 18px;
    }

    #kam-views a {
      color: navy;
    }

    #kam-views a.active {
      font-weight: bold;
      pointer-events: none;
    }

    #kam-views a:hover {
      color: orangered;
    }

    #kam-username {
      color: gray;
    }

    #game-list {
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
    }

    .game-item {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 200px;
      height: 200px;
      display: flex;
      flex-direction: column;
    }

    .game-item-title {
      font-size: 20px;
      font-weight: bold;
      color: gray;
      font-family: monospace;
      text-align: left;
    }

    .game-item-title:hover {
      color: #555;
    }

    .game-item-actions {
      /* Pin items to the bottom of div */
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    #editor-options {
      position: absolute;
      top: 40px;
      right: 30px;
      width: 123px;
      height: 50px;
      padding: 3px;
      border-radius: 2px;
      background-color: rgba(11, 0, 24, 0.6);

      /* Draggable */
      cursor: move;
      z-index: 5;
    }

    #editor-options:hover {
      background-color: rgba(11, 0, 24, 0.8);
    }


    #editor-options button {
      padding: 3px;
    }

    #editor-options span {
      color: white;
      float: right;
      font-size: 12px;
      font-family: monospace;
    }


    #view-html,
    #view-server,
    #view-stdout,
    #view-view,
    #home-games-project-join {
      position: absolute;
      top: 21px;
      right: 0;
      bottom: 0;
      left: 0;
    }

    #view-iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    /* STYLE.BUILD */
    #home-build label {
      font-size: 16px;
      font-weight: bold;
      color: #0A2A66;
    margin-bottom: 0;
    }
  </style>
</head>

<body>
  <!-- Toolbar pinned to the top that contains the current directory (page) and view optioons when page is "home-game-project-edit" -->
  <div class="toolbar">
    <div class="col md-12">
      <div class="float-left">
        <span id="kam-status">Connecting<span class="loading"></span></span>
        <span id="kam-breadcrumbs"> | Games > test > Editing server.js</span>
      </div>
      <div class="float-right">
        <span id="kam-views">
          <a href="javascript:void(0)" id='html' onclick="chView('html')">html</a> |
          <a href="javascript:void(0)" id='view' onclick="chView('view')">view</a>&nbsp;
          <a href="javascript:void(0)" id='server' onclick="chView('server')">server</a> |
          <a href="javascript:void(0)" id='stdout' onclick="chView('stdout')">stdout</a>
        </span>
      </div>
    </div>
  </div>

  <!-- Home page with cool spinning globe in background -->
  <div class="page" id="home">
    <div id="globeViz"></div>

    <div id="btn-container">
      <button class="btn-glass" onclick="chPage('home-login')" onmouseenter="putInstructions('login')"
        onmouseleave="putInstructions()" id="btn-login">Login</button>
      <button class="btn-glass" onclick="chPage('home-games')" onmouseenter="putInstructions('enter')"
        onmouseleave="putInstructions()">Enter</button>
      <button class="btn-glass" onclick="chPage('home-build')" onmouseenter="putInstructions('build')"
        onmouseleave="putInstructions()">Build</button>
    </div>

    <div id="home-instructions-container">
      <span id="home-instructions"></span>
      <span id="logged-in-as-container" style="display:none">Logged in as <span id="logged-in-as"></span> <a
          href="javascript:void(0)" onclick="chName()" id="edit-name">edit name</a></span>
      <span id="white-screen">White screen? <a href="javascript:void(0)" onclick="hideGraphics(true)">hide graphics</a>
        - <a href="javascript:void(0)" onclick="hideGraphics(false)">dismiss</a></span>
      <span id="not-connected" style="display:none">You are disconnected <a href="javascript:void(0)"
          onclick="connectToServer()">reconnect</a></span>
    </div>
  </div>

  <!-- Dynamic login page -->
  <div class="page mt-3" id="home-login">
    <!-- Khan Academy profile preview (pp) card -->
    <div id="pp">
      <img id="pp-avatar">
      <div>
        <div id="pp-names">
          <span id="pp-real-name"></span>
          <span id="pp-username-container">@<input autocomplete="off" id="pp-username"
              placeholder="Enter your username or KAID" onkeyup="fetchUsername()"></span>
        </div>
        <p id="pp-bio"></p>
        <span id="pp-ep"></span>
      </div>
    </div>
    <div class="input-group">
      <button class="btn btn-primary" id="btn-login-as" onclick="logInAs()">Log in as <span
          id="login-as-username">[Unknown]</span></button>
      <button class="btn btn-secondary" id="btn-continue-as-guest" onclick="chPage('home')">Continue as guest</button>
    </div>
    <div id="bio-change-container" class="mt-3">
      <h3>Step 2 - Verify your account</h3>
      <p id="bio-change-instructions">To ensure this account belongs to you, add the <b id="bio-add-pin">[error, do not
          add this]</b> PIN to your Khan
        Academy bio. You can edit your bio
        with <a href="https://www.khanacademy.org/profile/me" target="_blank">this link</a>.</p>
      <button class="btn btn-primary" id="btn-verify" onclick="verifyBioChange()">Verify</button>
    </div>
  </div>

  <div class="container page mt-5" id="home-games">
    <h3>Games</h3>
    <button onclick="getProjects()" class="btn btn-dark btn-sm">Refresh</button>
    <div id="game-list"> </div>
  </div>

  <div class="container page mt-5" id="home-games-project">
    <h4 id="kam-proj-title">Project</h4>
    <p id="kam-proj-desc" contenteditable="true">desc</p>
    Version: <p id="kam-proj-version" contenteditable="true">v</p>
    Author: <b id="kam-proj-author">a</b>
    <br><br>
    <button class="btn btn-success" onclick="joinProject()" id="kam-proj-join">Join</button>
    <button class="btn btn-dark" onclick="editProject()" id="kam-proj-edit">Edit</button>
    <hr />
    <button class="btn btn-success" onclick="updateProjectInfo()" id="kam-proj-save">Update info</button>
    <button class="btn btn-danger" onclick="deleteProject()" id="kam-proj-delete">Delete</button>
  </div>

  <div class="page mt-5" id="home-games-project-edit">
    <div id="view-server">function foo(items) {
      var x = "All this is syntax highlighted";
      return x;
    </div>
    <div id="view-html">
      <div id="editor-html">Loading HTML...</div>
    </div>
    <div id="view-view">
      <script type>
        // Create the iframe
        var iframe = document.createElement('iframe');
        iframe.id = 'view-iframe';

        // Listen for messages from the iframe
        iframe.onload = function () {
          iframe.contentWindow.addEventListener('message', event => {
            // Detect if iframe is self
            if (event.source !== iframe.contentWindow) {
              return;
            }
            send("^" + JSON.stringify(event.data));
          });
        };

        // Append iframe to document body
        document.getElementById('view-view').appendChild(iframe);
      </script>
    </div>

    <div id="editor-options">
      <button class="btn btn-sm btn-info" id="editor-save" onclick="saveClientCode()">Save</button>
      <button class="btn btn-sm btn-success" id="editor-run" onclick="runServerCode()">Run</button>
      <button class="btn btn-sm btn-danger" id="editor-stop" onclick="stopServerCode()">Stop</button>
      <span id="editor-status">status</span>
    </div>
  </div>

  <div class="page" id="home-games-project-join">
  </div>

  <div class="page container mt-5" id="home-build">
    <p id="disclaimer" style="border: dotted black 2px; padding: 10px"><b>DISCLAIMER - PLEASE READ </b><br>
      Your deno project can be publicly removed by the server admin for any reason, such as:<br>
      - Your project is not compatible with the latest version of the server<br>
      - Your project contains malicious code (without permission)<br>
      - Your project contains violent or adult content<br>
      - Your project contains copyrighted content<br>
      - Your project attempts compromise its users' privacy<br>
      Do not use this app to engage in illegal activities.<br>
      <button onclick="acceptDisclaimer()">Ok, I agree</button>
    </p>
    <h3>Build deno project</h3>
    <div class="row">
      
      <div class="col-md-12">
        <p>Jumpstart your progress by starting from a template. Full explanation and code docs are given in the
          <b>default</b> template.
        </p>
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" id="build-dropdown-toggle" type="button" id="triggerId" data-bs-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Choose template
          </button>
          <button id="build-refresh" class="btn btn-success" onclick="refreshTemplateOptions()">Refresh</button>
          <div id="build-dropdown-menu" class="dropdown-menu" aria-labelledby="triggerId" style="height: 300px; overflow-y: scroll;">
            <h6 class="dropdown-header">Start here</h6>
            <a class="dropdown-item" href="javascript:void(0)">default</a>
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">Basic</h6>
            <div id="template-basic">
            </div>
            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">Community</h6>
            <div id="template-community">
            </div>
          </div>
        </div>
      </div>
    </div>
    <h5 class="mt-3">Template:<span id="build-title"></span></h5>
    <form class="row">
      <div class="form-group col-8">
        <label for="build-new-name">New name</label>
        <input type="text" class="form-control" id="build-new-name" placeholder="Project name">
      </div>
      <div class="form-group col-4">
        <label for="build-version">Version</label>
        <input type="text" class="form-control" id="build-version" placeholder="1.0">
      </div>
      <div class="form-group col-12">
        <label for="build-desc">Description</label>
        <!-- Multi-line -->
        <textarea class="form-control" id="build-desc" rows="3"></textarea>
      </div>
      <div class="form-group col-6" style="margin-left: 20px">

        <input class="form-check-input" type="checkbox" value="" id="build-is-template">
        <label class="form-check-label" for="build-is-template">List as Template</label>
      </div>

    </form>
    <div class="mb-3">
      <button id="build-back" class="btn btn-dark" onclick="chPage('home')">Back</button>
      <button id="build-create" class="btn btn-primary" disabled onclick="buildProjectFromTemplate()">Create</button>
      <a href="javascript:void(0)" style="float:right" onclick="viewDisclaimer()">View disclaimer</a>
    </div>
  </div>

  <div id="view-stdout">

  </div>




  <!-- SCRIPT.HOME -->
  <script type>
    var myGeo = {
      lat: 0,
      lng: 0
    }
    var serverGeo = {
      lat: 38,
      lng: -77
    }
    // Constants
    var ARC_ANIMATION_DURATION = 500;

    // Time of day
    var hours = new Date().getHours()
    var isDayTime = hours > 6 && hours < 20

    // Points
    var pointsData = []
    function clearPoints() {
      pointsData = []
      globe.pointsData([])
    }
    function addPoint(lat, lng, color) {
      var point = {
        lat,
        lng,
        size: 0.1,
        color: color || "darkorange"
      }
      pointsData.push(point)
      globe.pointsData(pointsData)
    }

    // Arcs
    var arcsData = []
    function addArc(startLat, startLng, endLat, endLng, color1, color2, onTouchdown) {
      function updateArcData() {
        let diff = false
        let dateNow = new Date().getTime()
        for (var i = arcsData.length - 1; i >= 0; i--) {
          if (dateNow - arcsData[i].created > ARC_ANIMATION_DURATION * 2 - 100) { // Remove old arcs
            arcsData.splice(i, 1);
            diff = true
          }
        }
        if (diff) {
          globe.arcsData(arcsData)
        }
      }
      var arc = {
        startLat,
        startLng,
        endLat,
        endLng,
        color: [color1, color2],
        created: new Date().getTime(),
      }
      arcsData.push(arc)
      globe.arcsData(arcsData)
      setTimeout(onTouchdown, ARC_ANIMATION_DURATION)
      setTimeout(updateArcData, ARC_ANIMATION_DURATION * 2)
    }

    var globeImages = {
      day: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Blue_Marble_2002_bg21600.png/2560px-Blue_Marble_2002_bg21600.png',
      night: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/BlackMarble20161km.jpg/2200px-BlackMarble20161km.jpg',
      amogus: 'https://upload.wikimedia.org/wikipedia/commons/f/f2/Mogus_drip.jpg',
      kalogo: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Khan_Academy_Logo_Old_version_2015.jpg',
    }

    var globe = Globe()
      .globeImageUrl(isDayTime ? globeImages.day : globeImages.night)
      .showAtmosphere(1)
      .atmosphereColor('lightskyblue')

      .onGlobeClick((d, e) => {
        addArc(myGeo.lat, myGeo.lng, serverGeo.lat, serverGeo.lng, '#ff0000', '#ff0000', () => {
          addArc(serverGeo.lat, serverGeo.lng, d.lat, d.lng, '#ff0000', '#ff0000')
        })

      })
      .onGlobeRightClick(() => {
        let randomImage = Object.values(globeImages)[Math.floor(Math.random() * Object.values(globeImages).length)]
        globe.globeImageUrl(randomImage)
      })
      .pointsData(pointsData)
      .pointAltitude('size')
      .pointColor('color')
      .arcsData(arcsData)
      .arcColor('color')
      .arcDashLength(1)
      .arcDashGap(100)
      .arcDashInitialGap(1)
      .arcDashAnimateTime(ARC_ANIMATION_DURATION)
      .arcsTransitionDuration(0)
      (document.getElementById('globeViz'));

    globe.controls().autoRotate = true;

    addPoint(myGeo.lat, myGeo.lng, '#00ff00')

    function putInstructions(buttonName) {
      let instructions = {
        undefined: '',
        login: "Login in with your Khan Academy account",
        enter: "Enter into the metaverse and join a multiplayer-enabled project",
        build: "Build a new metaverse project or use a template (must be logged in)",
      }
      document.getElementById('home-instructions').innerHTML = instructions[buttonName]
    }

    function hideGraphics(chColor) {
      if (chColor) document.getElementById('btn-container').style['background-color'] = '#0a082e'
      document.getElementById('white-screen').style.display = 'none'
    }

  </script>

  <!-- SCRIPT.LOGIN -->
  <script type>
    var uid = ""
    var bioChangePIN = "error";
    var ppAnimation = 1;
    var ppAnimationTarget = 1;
    var ppShown = true;
    var ppu = document.getElementById("pp-username")
    function ppShow() { // Show pp card and show small username input
      document.getElementById("btn-login-as").disabled = false;
      document.getElementById("bio-change-container").style.display = "none";
      ppAnimationTarget = 0;
    }
    function ppHide() { // Hide pp card and show large username input
      ppAnimationTarget = 1
    }
    function getPPUValue() {
      // Remove non-alphanumeric/underscore characters
      ppu.value = ppu.value.replace(/[^a-zA-Z0-9_]/g, "");
      return ppu.value
    }
    var usernameBlocking = false;
    var fetchingUsername = ""
    function fetchUsername() { // Show pp card if username input is focused

      if (usernameBlocking || fetchingUsername == getPPUValue()) {
        return
      }
      fetchingUsername = getPPUValue();
      if (fetchingUsername.length < 3) {
        ppHide()
        return;
      }
      usernameBlocking = true;

      send("!get-ka-profile " + fetchingUsername)
    }
    function logInAs() {
      document.getElementById("btn-login-as").disabled = true;
      document.getElementById("bio-change-container").style.display = "block";
      document.getElementById("bio-add-pin").textContent = bioChangePIN;
      let txt = document.getElementById("pp-bio").textContent
      // Make sure bio contains the PIN
      txt = `<b>New bio: </b>${txt.slice(0, 160 - bioChangePIN.length)}<span>${bioChangePIN}</span>`
      document.getElementById("pp-bio").innerHTML = txt
    }
    function verifyBioChange() {
      document.getElementById("btn-verify").disabled = true;
      send(`!sign-up-with-bio-pin ${localStorage.getItem("ka.metaverse:offerHash")}`)
    }

    function ppKeyframe(p) { // p = percentage of animation
      ppu.style.border = `${p < 0.1 ? 0 : 3 * p}px solid rgba(204, 204, 204, ${p})`;
      ppu.style["font-size"] = `${16 + 14 * p}px`;
      ppu.style.width = `${p < 0.5 ? "" : (85 * p * p) + "%"}`;
      ppu.style.height = `${p < 0.5 ? "" : (50 * p) + "px"}`;
      ppu.style.padding = `${20 * p}px`
      ppu.style["border-radius"] = "5px";
      if (p > 0.5) {
        ppu.style.marginLeft = `${600 * (1 - p)}px`
        if (ppShown) {
          ppShown = false;
          ppu.style.marginTop = "40px"
          document.getElementById("home-login").appendChild(ppu)
          document.getElementById("pp").style.display = "none";
          document.getElementById("btn-login-as").style.display = "none";
          document.getElementById("bio-change-container").style.display = "none";
          ppu.focus()
        }
      } else {
        if (!ppShown) {
          ppShown = true;
          ppu.style.marginLeft = "0px";
          ppu.style.marginTop = "0px"
          document.getElementById("pp-username-container").appendChild(ppu)
          document.getElementById("pp").style.display = "flex";
          document.getElementById("btn-login-as").style.display = "block";
          ppu.focus()
        }
      }
    }
    ppHide()
    ppKeyframe(1)
    setInterval(() => {
      if (page === "home-login") {///
        if (ppAnimation == ppAnimationTarget) {
          return
        } else if (Math.abs(ppAnimation - ppAnimationTarget) < 0.001) {
          ppAnimation = ppAnimationTarget;
          ppKeyframe(ppAnimation)
        } else {
          ppAnimation += (ppAnimationTarget - ppAnimation) * 0.07;
          ppKeyframe(ppAnimation)
        }
      }
    }, 1000 / 50) // 50 fps

    function chName() {
      let name = prompt("Enter your name: ")
      if (name == null) {
        return
      }
      name = name.trim()
      console.log(name, "hello");
      send("!change-guest-uid " + name)
      // Show login button
      document.getElementById("btn-login").style.display = "block";
      document.getElementById("edit-name").innerHTML = "edit name"
    }

  </script>

  <script type>{
      { }// highlighting fixed in vscode

      // SCRIPT.PROJECT
      var editorStatusCountup = -1;

      // Views setup
      var view = 'server'
      function chView(newView) {
        var views = document.getElementById('kam-views').getElementsByTagName('a');
        for (var i = 0; i < views.length; i++) {
          views[i].className = '';
          document.getElementById("view-" + views[i].id).style.display = 'none';
        }
        document.getElementById(newView).className = 'active';
        document.getElementById("view-" + newView).style.display = 'block';

        terminalActive = false;
        if (newView == 'view') {
          runHtmlCode()
        } else if (newView == 'stdout') {
          terminalActive = true;
        }
        view = newView;
      }

      // Create/set project
      var projects = []
      var myProject = {}
      var projectServerCode = ""
      var projectClientCode = ""
      function getProjects() {
        send("!deno-get-projects")
        document.getElementById('game-list').innerHTML = '<div>Loading<span class="loading"></span></div>'
      }
      function populateProjects() {
        let denoListHtml = ""
        // Sort by view count
        let getScore = (proj) => proj.views + (proj.author == uid) * 100000
        projects.sort((a, b) => {
          return getScore(b) - getScore(a)
        })
        for (let p of projects) {
          denoListHtml += `
<div class="game-item">
  <a class="game-item-title" href="javascript:void(0)" onclick="aboutProject('${p.name}')">
    ${p.name}
  </a>
  <div class="game-item-description">
    <p>
      ${p.desc}
    </p>
  </div>
  <div class="game-item-actions">
    <a href="javascript:void(0)" class="btn btn-success" onclick="joinProject('${p.name}')">Join</a>
    <a href="javascript:void(0)" class="btn btn-dark" onclick="editProject('${p.name}')">Edit</a>
  </div>
</div>
      `
        }
        document.getElementById('game-list').innerHTML = denoListHtml
      }
      function aboutProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        // Update html
        document.getElementById('kam-proj-title').textContent = myProject.name;
        document.getElementById('kam-proj-desc').textContent = myProject.desc;
        document.getElementById('kam-proj-version').textContent = myProject.version;
        document.getElementById('kam-proj-author').textContent = myProject.author;

        // Disable buttons and stdout view if you're not the author
        let disableBtns = myProject.author !== uid;
        document.getElementById('kam-proj-save').disabled = disableBtns;
        document.getElementById('kam-proj-edit').innerHTML = disableBtns ? 'Edit (view only)' : 'Edit';
        document.getElementById('kam-proj-delete').disabled = disableBtns;
        document.getElementById('editor-save').disabled = disableBtns;
        document.getElementById('editor-run').disabled = disableBtns;
        document.getElementById('editor-stop').disabled = disableBtns;
        document.getElementById('stdout').style['pointer-events'] = disableBtns ? 'none' : 'auto';

        // Disable editors
        editorHtml.setReadOnly(disableBtns);
        editorServer.setReadOnly(disableBtns);

        // Editor options text
        document.getElementById('editor-status').textContent = disableBtns ? 'No edit access' : 'Not running';

        chPage('home-games-project');
      }
      function joinProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        chPage('home-games-project-join')
        iframe.srcdoc = "Loading..."
        document.getElementById('home-games-project-join').appendChild(iframe) // Move iframe to home-games-project-join page
        send("!join-game " + myProject.name)
      }
      function leaveProject() {
        send("!leave-game")
        chPage('home-games-project')
      }
      function updateProjectInfo() {
        function alphanumericOrDashFilter(str) {
          return str.replace(/\W/g, '-').replace(/[^a-z0-9-]/gi, '');
        }
        myProject = {
          name: myProject.name,
          desc: document.getElementById('kam-proj-desc').textContent.slice(0, 1024), // Shorten
          version: document.getElementById('kam-proj-version').textContent.slice(0, 20),
          author: uid,
          lastUpdated: Date.now()
        }
        aboutProject();
        send("!deno-update-info " + JSON.stringify(myProject))
      }
      function editProject(projName) {
        myProject = projName ? projects.find(p => p.name == projName) : myProject;
        if (!myProject) {
          alert("Project not found")
          return
        }
        aboutProject();
        chPage('home-games-project-edit');
        projectServerCode = "Loading..."
        projectClientCode = "Loading...";
        editorServer.getSession().setValue("Loading...");
        send("!deno-get-code " + myProject.name);
      }
      function deleteProject() {
        let r = confirm("Are you sure you want to delete this project?")
        if (r) {
          send("!deno-delete-project " + myProject.name)
          chPage('home-games');
        }
      }

      function runServerCode() {
        chView('stdout');
        editorStatusCountup = 0;
        let serverCode = editorServer.getSession().getValue();
        let obj = {
          project: myProject.name,
          code: serverCode
        }
        send("!deno-save-and-run-server " + JSON.stringify(obj));
        document.getElementById('editor-status') = "Starting..."
      }
      function stopServerCode() {
        send("!deno-kill")
      }
      function runHtmlCode() {
        var htmlCode = editorHtml.getValue();
        iframe.srcdoc = htmlCode; // iframe is global
      }
      function saveClientCode() {
        document.getElementById("editor-save").disabled = true
        let clientCode = editorHtml.getSession().getValue();
        let obj = {
          project: myProject.name,
          code: clientCode
        }
        send("!deno-save-client " + JSON.stringify(obj));
      }

      // Make editor-options draggable
      dragElement(document.getElementById("editor-options"));

      function dragElement(elmnt) { // Source: https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_draggable
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "header")) {
          document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
        } else {
          elmnt.onmousedown = dragMouseDown;
        }
        function dragMouseDown(e) {
          e = e || window.event;
          e.preventDefault();
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
          elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }


      // Editor setup
      var editorHtml
      var editorServer
      function initEditors() {
        // HTML editor
        editorHtml = ace.edit("view-html");
        editorHtml.setTheme("ace/theme/monokai-light");
        editorHtml.session.setMode("ace/mode/html");

        // Server editor
        editorServer = ace.edit("view-server");
        editorServer.setTheme("ace/theme/monokai");
        editorServer.session.setMode("ace/mode/javascript");
      }
      initEditors()

      // Page setup
      var page = "home"
      function chPage(newPage) {
        // If old page was home-games-project-join, leave it
        console.log("old page: " + page, "new page: " + newPage)
        if (page === "home-games-project-join" && newPage !== "home-games-project-join") {
          console.log("Leaving project join page")
          send("!leave-game")
        }
        function breadcrumbTextView(s) {
          s = s[0].toUpperCase() + s.slice(1)
          return s.replace("Edit", "edit").split("-").map(s => s.replace("Project", myProject.name))
        }
        document.getElementById(page).style.display = "none";
        page = newPage
        document.getElementById(page).style.display = "block";
        let fullPath = ""
        document.getElementById("kam-breadcrumbs").innerHTML = page.split("-").map(s => {
          fullPath += s + "-"
          return `<a href="javascript:void(0)" onclick='chPage("${fullPath.slice(0, fullPath.length - 1)}")'>${breadcrumbTextView(s)}</a>`
        }).join(" &gt; ")

        // Special rules
        if (page === "home") {
          if (isConnected) send("!globe")
          document.getElementById("view-stdout").style.display = "none";
          document.getElementById("kam-views").style.display = "none";
        } else if (page == "home-games-project-edit") {
          document.getElementById("kam-views").style.display = "inline";
          chView("html");
          document.getElementById("view-view").appendChild(iframe); // Move iframe to home-games-project-edit page
        } else {
          document.getElementById("kam-views").style.display = "none";
          terminalActive = false;
          editorStatusCountup = -1;
          document.getElementById("view-stdout").style.display = "none";
          document.getElementById("btn-verify").disabled = false;
        }

      }
      document.querySelectorAll(".page").forEach(v => v.style.display = "none") // Hide all pages
      setTimeout(() => chPage("home"), 0)


      function send(ele) {
        if (!isConnected) {
          alert("You are not connected")
          return
        }
        peer.send(ele)
      }

      var terminalActive = false
      function onRecieve(data) {
        console.log("%c" + data, 'background: #000; color: #ff00ff')
        if (data.startsWith("~")) {
          // Send message to terminal if it is open
          if (page === "home-games-project-edit") {
            term.write((data.slice(1)).replace(/\x07/g, "\x1b[31m[DEBUG]\x1b[0m ").replace(/\n/g, "\r\n"))
          }
          return
        }
        if (data.startsWith("^")) {
          // Send message to terminal if it is open
          if (page == "home-games-project-edit") {
            term.write(data.replace(/\n/g, "\r\n"))
          }

          // Also send message to iframe
          iframe?.contentWindow?.postMessage(data.slice(1), '*');
          return
        }
        let [firstArg, secondArg] = data.split(/ (.+)/s)
        if (firstArg === "!ping") {
          send("!pong")
        } else if (firstArg === "leave-room") {
          if (page === "home-games-project-join") {
            iframe.srcdoc = "";
            chPage("home")
          }
        } else if (firstArg == "deno-terminal-end") {
          if (page === "home-games-project-edit") {
            editorStatusCountup = -1;
            let statusCode = secondArg
            document.getElementById("editor-status").textContent = statusCode ? "Error" : "Success"
          } else if (page === "home-games-project-join") {
            iframe.srcdoc = "";
            leaveProject()
            alert("Game crashed on server")
          }
        } else if (firstArg === "deno-save-client-success") {
          document.getElementById("editor-save").disabled = false // enable button
        } else if (firstArg == "geo") {
          let geoData = JSON.parse(data.slice(4))
          /// TODO not used
        } else if (firstArg === 'deno-set-projects') {
          projects = JSON.parse(secondArg)
          populateProjects()
          populateTemplateOptions();
        } else if (firstArg === 'deno-set-server') {
          projectServerCode = secondArg
          editorServer.getSession().setValue(projectServerCode)
        } else if (firstArg === 'deno-set-client') {
          projectClientCode = secondArg
          editorHtml.getSession().setValue(projectClientCode)
        } else if (firstArg === 'set-iframe') {
          iframe.srcdoc = secondArg
        } else if (firstArg === 'deno-add-project') {
          myProject = JSON.parse(secondArg)
          if (myProject.prevName) {
            projects = projects.filter(p => p.name != myProject.prevName)
          }
          projects.push(myProject)
          populateProjects()
          aboutProject()
        } else if (firstArg === 'deno-remove-project') {
          removedProjectName = secondArg
          projects = projects.filter(p => p.name != removedProjectName)
          populateProjects()
        } else if (firstArg === 'set-uid') {
          uid = secondArg
          localStorage.setItem("ka.metaverse:uid", uid)
          document.getElementById("logged-in-as-container").style.display = "block"
          document.getElementById("logged-in-as").innerText = uid
          document.getElementById("kam-status").textContent = "✓"
        } else if (firstArg === "set-uid-error") {
          console.error(firstArg, secondArg)
          if (secondArg.includes("taken")) alert("Username already taken")
        } else if (firstArg === 'set-password') {
          localStorage.setItem("ka.metaverse:password", secondArg)
        } else if (firstArg === 'globe') {
          if (page === "home") {
            let globeData = JSON.parse(secondArg)
            let statusColors = {
              "online": "orange",
              "playing": "green",
              "offline": "gray",
              "self": "magenta"
            }
            clearPoints()
            for (let gd of globeData) {
              addPoint(gd.lat, gd.lng, statusColors[gd.status])
              if (gd.status === "self") {
                myGeo = { lat: gd.lat, lng: gd.lng }
              }
            }
          }
        } else if (firstArg === "get-ka-profile") {
          usernameBlocking = false;
          if (secondArg === "error") {
            ppHide()
          } else {
            let json = JSON.parse(secondArg)
            document.getElementById("pp-real-name").textContent = json.nickname;
            document.getElementById("pp-avatar").src = json.avatarSrc;
            document.getElementById("pp-bio").textContent = json.bio;
            document.getElementById("pp-ep").textContent = json.points ? "?" : "+" + json.points.toLocaleString()
            document.getElementById("login-as-username").textContent = fetchingUsername
            bioChangePIN = json.pin
            ppShow()
          }
          fetchUsername()
        } else if (firstArg === "sign-up-with-bio-pin") {
          document.getElementById("btn-verify").disabled = false;
          if (secondArg === "success") {
            alert("Success! You can now log in as " + fetchingUsername + " automatically.")
            // Remove login button on home page
            document.getElementById("btn-login").style.display = "none"
            document.getElementById("edit-name").innerHTML = "log out"
            chPage("home")
          } else if (secondArg === "error") {
            alert(`Your bio does not contain the PIN ${bioChangePIN}`)
          } else if (secondArg === "already") {
            alert(`You are already logged in to ${fetchingUsername}`)
          }
        } else if (firstArg === "auto-login") {
          if (secondArg === "error") {
            document.getElementById("kam-status").textContent = "Auto-login failed"
            send(`!get-guest-uid`)
          } else if (secondArg === "success") {
            // Remove login button on home page
            document.getElementById("btn-login").style.display = "none"
            document.getElementById("edit-name").innerHTML = "log out"
          }
        } else if (firstArg === "deno-create-project") {
          if (secondArg === "error") {
            alert("There was an error creating the project")
          }
        }
      }


      var serverIp = "173.79.147.118"
      var linkId = "5918360080531456"

      // Create 4-byte fingerprint and use that as answer line number
      var randomFingerprint = Math.random().toString(16).substring(2, 6)
      var answerLineNumber = parseInt(randomFingerprint.slice(0, 2), 16)
      var peer = null
      var isConnected = false

      connectToServer()
      function connectToServer() {


        parent?.peer?.destroy()
        peer = new SimplePeer({
          initiator: true,
          trickle: false,
          config: {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }]
          },
        }).on("signal", function (data) {
          console.log("%cCopy for manual input", "background: #000; font-size: x-large")
          console.log("%c" + "SDP_" + randomFingerprint + "_" + btoa(data.sdp), 'background: #000; color: #00ff00')
          document.getElementById("not-connected").style.display = "none"
          document.getElementById("kam-status").innerHTML = 'Connecting<span class="loading"></span>'
          sendSdpPackets(JSON.stringify(data))
        }).on("connect", function () {
          isConnected = true
          document.getElementById("kam-status").textContent = "✓"
          onServerConnected()
        }).on("data", function (data) {
          onRecieve(data.toString())
        }).on("close", function () {
          isConnected = false
          document.getElementById("kam-status").textContent = "Disconnected"
          document.getElementById("not-connected").style.display = "block"
        }).on("error", function (err) {
          document.getElementById("kam-status").textContent = "Error - open console";
          console.log("error", err)
        })
        parent.peer = peer

        function sendSdpPackets(content) {
          // PACKET FORMAT: 37cfa9{"type":"offer","sdp":"v=0\r\no...
          /** Breakdown
           *  - (1 char)    packet index (3=4th packet in hex)
           *  - (1 char)    number of packets (7=8 in hex), in case packets are received out of order
           *  - (4 chars)   packet fingerprint/identifier (example: cfa9)
           *  - (494 chars) packet content
           * 
           * In technical terms this has nothing to do with a network packet
           */
          let hex = "0123456789abcdef"
          let packetSize = 494
          if (content.length >= packetSize * 16) {
            document.getElementById("kam-status").textContent = "SDP offer too long to send";
            console.error("SDP offer too long")
            return
          }

          // Split up sdp data into up to 16 packets
          let packets = []
          for (let i = 0; i < content.length; i += packetSize) {
            packets.push(content.substr(i, packetSize))
          }

          // Send packets with header and index
          for (let i = 0; i < packets.length; i++) {
            let packet = hex[i] + hex[packets.length] + randomFingerprint + packets[i]
            sendToTurnServer(packet)
          }
          console.log(`Sent ${packets.length} packets with fingerprint ${randomFingerprint}`)

          setTimeout(attemptConnection, 2000)
        }

        function sendToTurnServer(content) {
          const pc = new RTCPeerConnection({
            iceServers: [{
              urls: [`turn:${serverIp}:3478`],
              username: content,
              credential: "1"
            }],
            iceCandidatePoolSize: 1
          })
          setTimeout(() => pc.close(), 1000)
        }
      }

      let connectionAttempts = 0
      function attemptConnection() {
        console.log('Attempting to connect...');
        let url = `https://www.khanacademy.org/api/internal/scratchpads/${linkId}?callback=?`
        parent.$.getJSON(url, data => {
          if (data == null) {
            document.getElementById("kam-status").innerHTML = "Link Program deleted - contact Squishy.";
            console.error("Connection error: Link Program was likely deleted. Please contact Squishy.")
            return
          }
          let linkProgramCode = data.revision.code.split('\n')
          let linkLastUpdated = new Date(data.revision.created)
          let nowDate = new Date()
          let diff = nowDate - linkLastUpdated
          let diffSeconds = Math.floor(diff / 1000)
          let diffHours = Math.floor(diff / (1000 * 60 * 60))

          // Detect a signal answer to my offer

          let serverOffer = linkProgramCode[answerLineNumber - 1]
          if (!serverOffer || !serverOffer.includes('answer=')) {
            connectionAttempts++
            if (connectionAttempts > 6) {
              document.getElementById('kam-status').textContent = "Server offline - contact Squishy."
              console.error("Connection error: Link Program is unresponsive. Please contact Squishy.")
              return
            }
            setTimeout(attemptConnection, 1000) // Wait 1 second and try again
            return
          }

          serverOffer = serverOffer.split(/\=(.+)/)[1] // Remove offerAnswer=
          peer.signal(serverOffer)
        })

      }

      function onServerConnected() {
        // Wait 0.5 seconds to make sure the server has time to connect
        setTimeout(() => {
          getProjects()
          send("!globe") // Get globe data

          // Auto-login or create guest account
          uid = localStorage.getItem("ka.metaverse:uid")
          let password = localStorage.getItem("ka.metaverse:password")
          let oh = localStorage.getItem("ka.metaverse:offerHash")
          localStorage.setItem("ka.metaverse:offerHash", oh || Math.random().toString())
          if (uid && password && !uid.includes("-")) { // If uid has dash, it's a default guest/custom guest account
            document.getElementById("kam-status").innerHTML = 'Logging in<span class="loading"></span>'
            send(`!auto-login ${uid} ${password} ${oh}`) // Login to the server
          } else {
            send(`!get-guest-uid ${oh}`) // Get guest (temporary) username for those who don't log in yet
          }
        }, 500)

      }

      // Update loading ellipsis
      setInterval(() => {
        document.querySelectorAll(".loading").forEach(ele => {
          ele.innerHTML += "."
          if (ele.innerHTML.length > 3) {
            ele.innerHTML = ""
          }
        })
      }, 250)

      // If terminal is active, increment the editor-status countup
      setInterval(() => {
        if (editorStatusCountup >= 0) {
          editorStatusCountup += 1
          let hours = Math.floor(editorStatusCountup / 3600)
          let minutes = Math.floor((editorStatusCountup - hours * 3600) / 60)
          let seconds = Math.floor(editorStatusCountup - hours * 3600 - minutes * 60)
          document.getElementById("editor-status").textContent = `${hours}h ${minutes}m ${seconds}s`
        }
      }, 1000)




    }

  </script>

  <script type>
    // SCRIPT.BUILD
    // Detect dropdown selection without jQuery
    var dropdown = document.querySelector('#build-dropdown-menu');
    document.querySelector('#build-dropdown-toggle').addEventListener('click', function () {
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    function onTemplateSelect(projName) {
      let projectMatch = projects.find(proj => proj.name == projName)
      document.querySelector('#build-title').innerHTML = projName;
      document.querySelector('#build-version').value = projectMatch.version
      document.querySelector('#build-desc').value = projectMatch.desc
    }
    function acceptDisclaimer() {
      document.querySelector('#disclaimer').style.display = 'none';
      document.querySelector('#build-create').disabled = false;
    }
    function viewDisclaimer() {
      document.querySelector('#disclaimer').style.display = 'block';
      window.scrollTo(0, 0);
    }
    function populateTemplateOptions() {
      let templateBasic = document.querySelector('#template-basic');
      let templateCommunity = document.querySelector('#template-community');
      projects.filter(proj => !proj.isTemplate).forEach(function (proj) {
        let option = document.createElement('a');
        option.className = 'dropdown-item';
        option.href = '#';
        option.textContent = proj.name;
        let templateOptions = proj.isBasicTemplate ? templateBasic : templateCommunity;
        templateOptions.appendChild(option);
      });

      document.querySelectorAll('#build-dropdown-menu a').forEach(function (element) {
        element.addEventListener('click', function () {
          dropdown.style.display = 'none';
          let name = element.textContent;
          onTemplateSelect(name);
        });
      });
    }
    function refreshTemplateOptions() {
      document.querySelector('#build-refresh').disabled = true;
      let templateBasic = document.querySelector('#template-basic');
      let templateCommunity = document.querySelector('#template-community');
      templateBasic.innerHTML = '';
      templateCommunity.innerHTML = '';
      send("!deno-get-projects")
    }
    function buildProjectFromTemplate() {
      let projBasedOn = document.querySelector('#build-title').innerHTML;
      let projName = document.querySelector('#build-new-name').value;
      let projVersion = document.querySelector('#build-version').value;
      let projDesc = `Based on ${projBasedOn}.\n${document.querySelector('#build-desc').value}`;
      let projIsTemplate = document.querySelector('#build-is-template').checked;
      if (projName == '') {
        alert('Project name cannot be empty');
        return;
      }
      if (projects.find(proj => proj.name == projName)) {
        alert('Project name already exists');
        return;
      }
      if (projBasedOn == '') {
        alert('Please select a template');
        return;
      }
      let projObj = {
        basedOn: projBasedOn,
        name: projName,
        desc: projDesc,
        version: projVersion,
        isTemplate: projIsTemplate,
      };
      send('!deno-create-project ' + JSON.stringify(projObj));
    }
  </script>
  <script type>
    var term = new Terminal({
      cursorBlink: true,
      cols: 65,
      rows: 19,
    });
    var fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    fitAddon.fit();
    term.open(document.getElementById('view-stdout'));
    term.nextLine = function () {
      term.write('\r\nmetaverse $ ');
    };
    term.prompt = () => {
      term.write('\n')
      if (term.currLine == "cls" || term.currLine == "clear") {
        term.clear()
      } else if (term.currLine == "help\r") {
        term.nextLine()
      } else {
        send("^" + term.currLine.toString().trim()) // todo only send if server is not running
      }
      term.currLine = "";
    };
    term.currLine = "";
    term.write('metaverse $ ')
    term.onKey(e => {
      if (e.key === "Backspace") { // Backspace
        term.write('\b \b');
        term.currLine = term.currLine.slice(0, -1);
      } else if (e.key === '\r') { // Enter
        term.write('\r\n');
        term.prompt()
      } else {
        term.currLine += e.key;
        term.write(e.key);
      }
    })
    // Set theme to xterm.js
    term.setOption('theme', {
      "name": "Atom",
      "black": "#000000",
      "red": "#fd5ff1",
      "green": "#87c38a",
      "yellow": "#ffd7b1",
      "blue": "#85befd",
      "purple": "#b9b6fc",
      "cyan": "#85befd",
      "white": "#e0e0e0",
      "brightBlack": "#000000",
      "brightRed": "#fd5ff1",
      "brightGreen": "#94fa36",
      "brightYellow": "#f5ffa8",
      "brightBlue": "#96cbfe",
      "brightPurple": "#b9b6fc",
      "brightCyan": "#85befd",
      "brightWhite": "#e0e0e0",
      "background": "#161719",
      "foreground": "#c5c8c6",
      "selectionBackground": "#444444",
      "cursorColor": "#d0d0d0"
    });
    document.getElementById('view-stdout').style.display = 'none';
  </script>
  <script></script>
</body>

</html>